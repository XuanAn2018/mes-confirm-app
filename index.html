<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Final Confirm - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette m√†u Anti-Glare */
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); /* Blue */
            --confirm-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Emerald */
            --register-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); /* Violet */
            --copy-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); /* Amber */
            
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            background: #0f172a; /* Slate 900 */
            color: white;
            padding: 1rem 2rem;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky; top: 0; z-index: 100;
        }
        
        .brand {
            font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 10px; color: #f8fafc;
        }
        
        .status-badge {
            font-size: 0.85rem; padding: 6px 16px; border-radius: 99px; font-weight: 600;
            background: rgba(56, 189, 248, 0.15); color: #38bdf8; border: 1px solid rgba(56, 189, 248, 0.2);
        }

        /* Layout */
        .container {
            max-width: 1400px; margin: 25px auto; padding: 0 20px;
            display: grid; grid-template-columns: 400px 1fr; gap: 25px;
        }
        @media (max-width: 1024px) { .container { grid-template-columns: 1fr; } }

        /* Cards */
        .card {
            background: var(--bg-card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px;
            border: 1px solid white; display: flex; flex-direction: column;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9;
        }
        .card-title { font-weight: 700; color: #334155; display: flex; align-items: center; gap: 8px; }

        /* Inputs */
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        input, textarea {
            width: 100%; padding: 10px 12px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 0.95rem; background: #f8fafc; transition: all 0.2s;
        }
        input:focus, textarea:focus {
            border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none;
            color: white; transition: all 0.2s ease; font-size: 0.95rem; width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }

        .btn-search { background: var(--primary-gradient); }
        .btn-confirm { background: var(--confirm-gradient); }
        .btn-register { background: var(--register-gradient); }
        .btn-copy { background: var(--copy-gradient); }

        /* Cookie Components Tag */
        .cookie-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .tag {
            font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; border: 1px solid;
            display: flex; align-items: center; gap: 4px;
        }
        .tag-valid { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .tag-missing { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card {
            background: white; padding: 15px; border-radius: var(--radius);
            box-shadow: var(--shadow); text-align: center; border-bottom: 4px solid transparent;
        }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: #1e293b; }
        .stat-label { font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-card.total { border-color: #3b82f6; }
        .stat-card.selected { border-color: #8b5cf6; }
        .stat-card.confirmed { border-color: #10b981; }

        /* Table */
        .table-container {
            max-height: 450px; overflow-y: auto;
            border: 1px solid #e2e8f0; border-radius: 8px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th {
            background: #f1f5f9; position: sticky; top: 0; z-index: 10;
            padding: 12px; text-align: left; font-weight: 600; color: #475569;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
        }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:hover { background: #f8fafc; }
        
        /* Badges in Table */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #dcfce7; color: #15803d; }
        .badge-warning { background: #fef9c3; color: #a16207; }
        .badge-neutral { background: #f1f5f9; color: #64748b; }

        /* Logs */
        .log-container {
            background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px;
            font-family: 'Consolas', monospace; font-size: 0.85rem; height: 200px; overflow-y: auto;
            border: 1px solid #334155;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-time { color: #64748b; margin-right: 8px; }

        /* Format Radio */
        .format-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .radio-label {
            flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px;
            cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 6px;
        }
        .radio-label:hover { background: #f8fafc; }
        .radio-label input:checked + span { color: #3b82f6; font-weight: 700; }

        /* Animations */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .btn-pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <div class="navbar">
        <div class="brand">
            <span>üè≠ MES FINAL CONFIRM</span>
        </div>
        <div class="status-badge" id="appStatus">Ready</div>
    </div>

    <div class="container">
        
        <!-- Left Column: Config & Tools -->
        <div class="left-col">
            
            <!-- Auth Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîê X√°c th·ª±c Cookie</div>
                </div>
                <label>D√°n Cookie t·ª´ F12:</label>
                <textarea id="cookie" placeholder="ASP.NET_SessionId=...; .ASPXAUTH=..." rows="3" oninput="checkCookieComponents()"></textarea>
                <div class="cookie-tags" id="cookieComponents"></div>
            </div>

            <!-- Scanner Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîç Qu√©t Package</div>
                </div>
                <label>Package Group:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="packageGroup" placeholder="V√≠ d·ª•: PG_20241128...">
                </div>
                <button class="btn btn-search" onclick="getPackages()" style="margin-top: 15px;">
                    üîç L·∫•y Danh S√°ch
                </button>
            </div>

            <!-- Copy Tool Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã C√¥ng c·ª• Copy</div>
                </div>
                <div class="format-group">
                    <label class="radio-label" onclick="selectFormat('inline')">
                        <input type="radio" name="format" value="inline" checked>
                        <span>Ngang (Space)</span>
                    </label>
                    <label class="radio-label" onclick="selectFormat('multiline')">
                        <input type="radio" name="format" value="multiline">
                        <span>D·ªçc (Xu·ªëng d√≤ng)</span>
                    </label>
                </div>
                <textarea id="copy-output" readonly placeholder="K·∫øt qu·∫£ copy..." rows="4"></textarea>
                <button class="btn btn-copy" onclick="copyPackages()" style="margin-top: 10px;">
                    üìã Sao Ch√©p
                </button>
            </div>
        </div>

        <!-- Right Column: Data & Actions -->
        <div class="right-col">
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">T·ªïng Package</div>
                </div>
                <div class="stat-card selected">
                    <div class="stat-value" id="stat-selected">0</div>
                    <div class="stat-label">ƒê√£ ch·ªçn</div>
                </div>
                <div class="stat-card confirmed">
                    <div class="stat-value" id="stat-confirmed">0</div>
                    <div class="stat-label">ƒê√£ x√°c nh·∫≠n</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card" style="flex-direction: row; gap: 15px; padding: 15px; background: transparent; box-shadow: none; border: none; margin-bottom: 10px;">
                <button class="btn btn-confirm" onclick="confirmSelected()">
                    ‚úÖ X√°c nh·∫≠n (Confirm)
                </button>
                <button class="btn btn-register" onclick="sendToAutoRegister()">
                    üöÄ G·ª≠i Auto Register
                </button>
            </div>

            <!-- Table -->
            <div class="card" style="flex: 1;">
                <div class="card-header">
                    <div class="card-title">üì¶ Danh s√°ch Package</div>
                    <span style="font-size: 0.8rem; color: #64748b;">(Ch·ªçn package ƒë·ªÉ x·ª≠ l√Ω)</span>
                </div>
                <div class="table-container">
                    <div id="package-list">
                        <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            Vui l√≤ng nh·∫≠p Package Group v√† nh·∫•n "L·∫•y Danh S√°ch"
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="log-container" id="log-container">
                <div class="log-entry"><span class="log-time">SYSTEM</span> H·ªá th·ªëng s·∫µn s√†ng.</div>
            </div>
        </div>

    </div>

    <script>
        // === C·∫§U H√åNH HARDCODED ===
        const FINAL_CONFIRM_URL = "https://mes-final-confirm.chiscoong-cloudflare-com.workers.dev";
        const AUTO_REGISTER_URL = "https://auto-register.chiscoong-cloudflare-com.workers.dev";
        
        // Globals
        let currentPackages = [];
        let selectedFormat = 'inline';
        const IMPORTANT_COOKIES = ['ASP.NET_SessionId', '.ASPXAUTH', 'PUNGKOOKUSID'];

        // --- CORE FUNCTIONS ---

        window.onload = function() {
            const savedCookie = localStorage.getItem('cookie');
            if (savedCookie) {
                document.getElementById('cookie').value = savedCookie;
                checkCookieComponents();
            }
            log('Ch√†o m·ª´ng! Vui l√≤ng nh·∫≠p Cookie ƒë·ªÉ b·∫Øt ƒë·∫ßu.', '#60a5fa');
        }

        function log(msg, color = '#e2e8f0') {
            const time = new Date().toLocaleTimeString('vi-VN', {hour12:false});
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">[${time}]</span> <span style="color:${color}">${msg}</span>`;
            const container = document.getElementById('log-container');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function checkCookieComponents() {
            const cookie = document.getElementById('cookie').value.trim();
            const container = document.getElementById('cookieComponents');
            container.innerHTML = '';

            if(cookie) localStorage.setItem('cookie', cookie);

            IMPORTANT_COOKIES.forEach(comp => {
                const isValid = cookie.includes(comp + '=');
                const tag = document.createElement('div');
                tag.className = `tag ${isValid ? 'tag-valid' : 'tag-missing'}`;
                tag.innerHTML = `${isValid ? '‚úì' : '‚ö†'} ${comp}`;
                container.appendChild(tag);
            });
        }

        async function getPackages() {
            const cookie = document.getElementById('cookie').value.trim();
            const group = document.getElementById('packageGroup').value.trim();
            
            if(!cookie || !group) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Cookie v√† Package Group!");

            const btn = document.querySelector('.btn-search');
            btn.textContent = "‚è≥ ƒêang qu√©t..."; btn.disabled = true;
            log(`ƒêang qu√©t Package Group: ${group}...`, '#60a5fa');

            try {
                const res = await fetch(`${FINAL_CONFIRM_URL}/api/get-packages?group=${group}`, {
                    headers: { 'X-MES-Cookie': cookie }
                });

                if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
                const data = await res.json();
                
                if(data.error) throw new Error(data.error);

                currentPackages = data;
                renderTable(data);
                updateStats();
                updateCopyOutput();
                log(`‚úÖ ƒê√£ t√¨m th·∫•y ${data.length} packages.`, '#4ade80');

            } catch(e) {
                log(`‚ùå L·ªói: ${e.message}`, '#f87171');
                document.getElementById('package-list').innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444">${e.message}</div>`;
            } finally {
                btn.textContent = "üîç L·∫•y Danh S√°ch"; btn.disabled = false;
            }
        }

        function renderTable(pkgs) {
            if(!pkgs.length) {
                document.getElementById('package-list').innerHTML = '<div style="padding:20px; text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                return;
            }

            let html = `<table><thead><tr>
                <th width="40"><input type="checkbox" onchange="toggleAll(this)"></th>
                <th>Seq</th>
                <th>MxPackage</th>
                <th>Status Name</th>
                <th>Confirm (OPS)</th>
            </tr></thead><tbody>`;

            pkgs.forEach((p, i) => {
                const name = p.MxPackage || p.mxPackage || p.PackageName || 'N/A';
                const statusName = p.StatusName || p.statusName || '';
                const confirmChk = p.CONFIRMCHK || p.confirmChk || 'N';
                const seq = p.SeqNo || i + 1;

                const statusBadge = statusName.toLowerCase().includes('confirmed') 
                    ? `<span class="badge badge-success">${statusName}</span>` 
                    : `<span class="badge badge-warning">${statusName || 'Pending'}</span>`;

                const opsBadge = confirmChk === 'Y' 
                    ? `<span class="badge badge-success">YES</span>` 
                    : `<span class="badge badge-neutral">NO</span>`;

                html += `<tr>
                    <td><input type="checkbox" class="pkg-chk" data-pkg="${name}" data-seq="${seq}" onchange="updateStats()"></td>
                    <td>${seq}</td>
                    <td style="font-weight:600; color:#2563eb">${name}</td>
                    <td>${statusBadge}</td>
                    <td>${opsBadge}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('package-list').innerHTML = html;
        }

        function toggleAll(source) {
            document.querySelectorAll('.pkg-chk').forEach(c => c.checked = source.checked);
            updateStats();
        }

        function updateStats() {
            const total = currentPackages.length;
            const selected = document.querySelectorAll('.pkg-chk:checked').length;
            const confirmed = currentPackages.filter(p => (p.StatusName || '').toLowerCase().includes('confirmed')).length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-selected').textContent = selected;
            document.getElementById('stat-confirmed').textContent = confirmed;
        }

        async function confirmSelected() {
            const chks = document.querySelectorAll('.pkg-chk:checked');
            if(!chks.length) return alert("Ch∆∞a ch·ªçn package n√†o!");
            
            const cookie = document.getElementById('cookie').value.trim();
            const group = document.getElementById('packageGroup').value.trim();
            if(!cookie) return alert("Thi·∫øu Cookie!");

            if(!confirm(`X√°c nh·∫≠n ${chks.length} package ƒë√£ ch·ªçn?`)) return;

            log(`üöÄ B·∫Øt ƒë·∫ßu x√°c nh·∫≠n ${chks.length} package...`, '#fbbf24');
            
            for(const chk of chks) {
                const pkg = chk.dataset.pkg;
                const seq = chk.dataset.seq;
                
                try {
                    const res = await fetch(`${FINAL_CONFIRM_URL}/api/confirm`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-MES-Cookie': cookie },
                        body: JSON.stringify({ packageGroup: group, seqNo: parseInt(seq) })
                    });
                    const data = await res.json();
                    
                    if(data.ok) {
                        log(`‚úÖ [${pkg}] X√°c nh·∫≠n th√†nh c√¥ng`, '#4ade80');
                        chk.closest('tr').style.background = '#f0fdf4';
                    } else {
                        log(`‚ùå [${pkg}] L·ªói: ${data.message}`, '#f87171');
                        chk.closest('tr').style.background = '#fef2f2';
                    }
                } catch(e) {
                    log(`üí• [${pkg}] Exception: ${e.message}`, '#f87171');
                }
            }
            log("üèÅ Ho√†n t·∫•t qu√° tr√¨nh x√°c nh·∫≠n.", '#e2e8f0');
        }

        async function sendToAutoRegister() {
            const chks = document.querySelectorAll('.pkg-chk:checked');
            if(!chks.length) return alert("Ch∆∞a ch·ªçn package n√†o!");
            const cookie = document.getElementById('cookie').value.trim();
            if(!cookie) return alert("Thi·∫øu Cookie!");

            if(!confirm(`G·ª≠i ${chks.length} package t·ªõi Auto Register?`)) return;

            log(`üöÄ ƒêang g·ª≠i ${chks.length} package t·ªõi Auto Register...`, '#a78bfa');
            
            let success = 0;
            for(const chk of chks) {
                const pkg = chk.dataset.pkg;
                try {
                    const res = await fetch(`${AUTO_REGISTER_URL}/api/auto-register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-MES-Cookie': cookie },
                        body: JSON.stringify({ package: pkg })
                    });
                    const data = await res.json();
                    if(data.ok) {
                        log(`‚úÖ [${pkg}] Register OK`, '#4ade80');
                        success++;
                    } else {
                        log(`‚ö†Ô∏è [${pkg}] Register Fail: ${data.message}`, '#fcd34d');
                    }
                } catch(e) {
                    log(`üí• [${pkg}] Error: ${e.message}`, '#f87171');
                }
            }
            log(`üèÅ Ho√†n t·∫•t. Th√†nh c√¥ng: ${success}/${chks.length}`, '#e2e8f0');
        }

        // Copy Tools
        function selectFormat(fmt) {
            selectedFormat = fmt;
            updateCopyOutput();
        }

        function updateCopyOutput() {
            if(!currentPackages.length) return;
            const names = currentPackages.map(p => p.MxPackage || p.mxPackage || p.PackageName);
            const text = selectedFormat === 'inline' ? names.join(' ') : names.join('\n');
            document.getElementById('copy-output').value = text;
        }

        function copyPackages() {
            const el = document.getElementById('copy-output');
            if(!el.value) return;
            el.select();
            document.execCommand('copy');
            log(`üìã ƒê√£ copy ${currentPackages.length} package v√†o clipboard.`, '#fbbf24');
        }

    </script>
</body>
</html>
